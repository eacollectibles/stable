<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Buyback Portal – Working</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .card-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .remove-btn { background: red; color: white; border: none; padding: 6px 10px; cursor: pointer; }
    .search-icon { cursor: pointer; padding: 4px 8px; margin-left: 4px; }
    .autocomplete-results { position: absolute; background: white; border: 1px solid #ccc; z-index: 10; width: 250px; }
    .autocomplete-results div { padding: 5px; cursor: pointer; }
    .autocomplete-results div:hover { background: #eee; }
  </style>
</head>
<body>

  <h2>Trade-In Cards</h2>
  <form id="trade-form">
    <label for="employeeName"><strong>Employee:</strong></label>
    <select name="employeeName" id="employeeName" required>
      <option value="" disabled selected>Select Employee</option>
      <option value="Alex">Alex</option>
      <option value="Jamie">Jamie</option>
      <option value="Morgan">Morgan</option>
    </select><br><br>

    <div id="card-list"></div>
    <button type="button" id="add-card">➕ Add Card</button>
    <button type="submit" id="submit-trade">Submit Trade</button>
  </form>

  <div id="status-bar" style="margin-top: 20px; padding: 10px; display: none;"></div>
  <div id="trade-log" style="margin-top: 20px;"></div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const cardList = document.getElementById('card-list');
  const statusBar = document.getElementById('status-bar');

  function createCardRow() {
    const row = document.createElement('div');
    row.className = 'card-row';
    row.innerHTML = \`
      <div style="position: relative;">
        <div style="display: flex; align-items: center;">
          <input type="text" name="cardName" placeholder="Card Name" required />
          <button type="button" class="search-icon" title="Search">&#128269;</button>
        </div>
        <div class="autocomplete-results"></div>
      </div>
      <input type="number" name="cardQty" placeholder="Qty" min="1" value="1" required />
      <select name="cardCondition" required>
        <option value="NM">NM</option>
        <option value="LP">LP</option>
        <option value="MP">MP</option>
      </select>
      <button type="button" class="remove-btn">✖</button>
    \`;
    cardList.appendChild(row);

    const nameInput = row.querySelector('input[name="cardName"]');
    const searchBtn = row.querySelector('.search-icon');
    const removeBtn = row.querySelector('.remove-btn');
    const resultsDiv = row.querySelector('.autocomplete-results');

    removeBtn.onclick = () => row.remove();

    searchBtn.onclick = () => {
      const query = nameInput.value.trim();
      if (query.length < 2) {
        resultsDiv.innerHTML = '<div>Enter 2+ characters</div>';
        return;
      }
      fetch('/api/searchProducts?q=' + encodeURIComponent(query))
        .then(res => res.json())
        .then(data => {
          resultsDiv.innerHTML = '';
          if (!Array.isArray(data)) {
            resultsDiv.innerHTML = '<div>No results found</div>';
            return;
          }
          data.forEach(item => {
            const div = document.createElement('div');
            div.textContent = \`\${item.title} (\${item.sku}) - $\${item.price}\`;
            div.onclick = () => {
              nameInput.value = item.title;
              resultsDiv.innerHTML = '';
            };
            resultsDiv.appendChild(div);
          });
        })
        .catch(() => {
          resultsDiv.innerHTML = '<div>Search error</div>';
        });
    };
  }

  document.getElementById('add-card').addEventListener('click', createCardRow);
  createCardRow(); // Add one row by default

  document.getElementById('trade-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const employee = document.getElementById('employeeName').value;
    const rows = document.querySelectorAll('.card-row');
    const cards = [];

    rows.forEach(row => {
      const name = row.querySelector('input[name="cardName"]').value;
      const qty = row.querySelector('input[name="cardQty"]').value;
      const condition = row.querySelector('select[name="cardCondition"]').value;
      if (name && qty && condition) {
        cards.push({ name, quantity: parseInt(qty), condition });
      }
    });

    if (!employee || cards.length === 0) {
      alert('Please fill all required fields.');
      return;
    }

    fetch('/api/buybackstep4', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ employee, cards })
    })
    .then(res => res.json())
    .then(data => {
      statusBar.style.display = 'block';
      statusBar.style.background = res.ok ? '#d4edda' : '#f8d7da';
      statusBar.style.color = res.ok ? '#155724' : '#721c24';
      statusBar.textContent = res.ok ? 'Trade submitted successfully!' : 'Submission failed.';
    })
    .catch(err => {
      console.error(err);
      statusBar.style.display = 'block';
      statusBar.style.background = '#f8d7da';
      statusBar.style.color = '#721c24';
      statusBar.textContent = 'Error submitting trade.';
    });
  });
});
</script>

</body>
</html>