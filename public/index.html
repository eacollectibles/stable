
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TESTING VERSION – Buyback Portal</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, select, button { margin: 5px; padding: 8px; font-size: 14px; }
    .card-row { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
    .remove-btn { background: red; color: white; border: none; padding: 6px 10px; cursor: pointer; }
    #trade-result { margin-top: 20px; font-size: 16px; }
  </style>
</head>
<body>
  <div style="background: #ffd700; color: #000; text-align: center; font-weight: bold; padding: 10px;">
    TESTING VERSION ACTIVE
  </div>

  <h2>Trade-In Cards</h2>
  <form id="trade-form">
    <label for="employeeName"><strong>Employee:</strong></label>
    <select name="employeeName" id="employeeName" required style="margin-bottom: 10px;">
      <option value="" disabled selected>Select Employee</option>
      <option value="Alex">Alex</option>
      <option value="Jamie">Jamie</option>
      <option value="Morgan">Morgan</option>
      <option value="Taylor">Taylor</option>
    </select><br>
    <div id="card-list">
      <div class="card-row">
        <input type="text" name="cardName" placeholder="Card Name" required />
        <input type="number" name="cardQty" placeholder="Qty" min="1" value="1" required />
        <select name="cardCondition" required>
          <option value="NM">NM</option>
          <option value="LP">LP</option>
          <option value="MP">MP</option>
        </select>
        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">✖</button>
      </div>
    </div>
    <button type="button" id="add-card">➕ Add Card</button>
    <button type="submit" id="submit-trade">Submit Trade</button>
  </form>

  <div id="trade-result"></div>

  
<script>
document.addEventListener('DOMContentLoaded', function () {
  const cardList = document.getElementById('card-list');

  document.getElementById('add-card').addEventListener('click', function () {
    const newRow = document.createElement('div');
    newRow.className = 'card-row';
    newRow.innerHTML = `
      <input type="text" name="cardName" placeholder="Card Name" required />
      <input type="number" name="cardQty" placeholder="Qty" min="1" value="1" required />
      <select name="cardCondition" required>
        <option value="NM">NM</option>
        <option value="LP">LP</option>
        <option value="MP">MP</option>
      </select>
      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">✖</button>
    `;
    cardList.appendChild(newRow);
  });

  document.getElementById('trade-form').addEventListener('submit', function (e) {
    e.preventDefault();

    const cardRows = document.querySelectorAll('.card-row');
    const tradeResult = document.getElementById("trade-result");
    tradeResult.innerHTML = "Processing...";

    const employee = document.getElementById('employeeName')?.value || 'Unknown';
    let total = 0;
    let processed = 0;
    let summaryHTML = `<div><strong>Processed by:</strong> ${employee}</div>`;

    cardRows.forEach((row, index) => {
      const name = row.querySelector('input[name="cardName"]').value;
      const qty = parseInt(row.querySelector('input[name="cardQty"]').value) || 1;
      const cond = row.querySelector('select[name="cardCondition"]').value;

      fetch('/api/buybackstep4', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cardName: name })
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) {
          summaryHTML += `<div style="color: red;">${name}: ${data.error}</div>`;
        } else {
          const cardTotal = parseFloat(data.tradeInValue) * qty;
          total += cardTotal;

          summaryHTML += `
            <div style="margin-bottom: 10px;">
              <strong>${data.name}</strong> (${cond}) x${qty}<br>
              Retail: $${data.price.toFixed(2)} | Inventory: ${data.inventory}<br>
              Buyback Value: <span style="color: green;">$${data.tradeInValue}</span> × ${qty} = 
              <span style="color: darkgreen;">$${cardTotal.toFixed(2)}</span>
            </div>
          `;
        }
      })
      .catch(err => {
        console.error("API error:", err);
        summaryHTML += `<div style="color: red;">${name}: Error contacting API</div>`;
      })
      .finally(() => {
        processed++;
        if (processed === cardRows.length) {
          tradeResult.innerHTML = summaryHTML + `<hr><strong>Total Offer:</strong> <span style="color: darkgreen;">$${total.toFixed(2)}</span>`;
        }
      });
    });
  });
});
</script>

</body>
</html>
